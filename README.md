# HarmoGraph

ローカル実行専用の「ハモリ練習」Webアプリです。参照音源（ボーカル/コーラス）と自分の録音を比較し、ピッチ差分を可視化します。

## 仕様確定メモ
- 対象デバイス: PCブラウザのみ（Chrome / Edge）
- 参照音源: アップロード + アプリ内録音（ボーカル/コーラス両トラック）
- 練習時再生: ボーカル/コーラスを個別ON/OFF・Solo・音量調整
- 評価軸: ピッチ優先（開始ズレ補正のためグローバルオフセット推定あり）
- 許容誤差: 初期値 ±25 cents（UIで調整可能）
- 曲長: 5分想定、最大10分
- 保存単位: 「曲(Project)」単位で参照トラックと練習セッションをIndexedDB保存
- UI方針: 機能優先（CSSで簡易デザイン）

## 技術スタック
- Vite + React + TypeScript (strict)
- Web Audio API / MediaRecorder
- Basic Pitch（機械学習ベースのピッチ推定） + Viterbi最適化
- Canvas（ピッチ重ね描き）
- IndexedDB（idb）

## できること（MVP）
- 曲(Project)の作成
- 参照ボーカル/参照コーラスのアップロード
- 参照ボーカル/参照コーラスのアプリ内録音
- 参照ボーカル/参照コーラスの位置補正（±2000ms）
- 参照ボーカル/参照コーラスの波形を上下表示し、再生しながら位置合わせ
- テンポ(BPM)指定、拍子(3/4, 4/4)、クリック音量、クリックオフセット(±500ms)調整
- 解析は参照ボーカル（単旋律ガイド）固定
- 録音からノート列（MIDI相当）を抽出してピアノロール表示
- 抽出ノートをピアノ音で再生
- 2秒カウント後のマイク録音（参照再生しながら）
- ピッチ抽出（clarityしきい値未満は未検出扱い）
- 録音開始ズレの自動推定（相互相関）
- 手動オフセット調整（±500ms）+ 再解析
- ピッチ重ね描き + 外れ区間ハイライト
- 統計表示（平均/中央値/最大/合格割合/未検出率）
- 外れ区間トップ3へのジャンプ再生
- Project単位のローカル保存/復元

## 主要モジュール
- `src/lib/recorder.ts`
  - マイク録音開始/停止（MediaRecorder）
- `src/lib/analyzer.ts`
  - ピッチ抽出（Basic Pitch）、cents差分、統計、外れ区間抽出、オフセット推定
- `src/lib/audioUtils.ts`
  - デコード、モノラル化、平滑化などの音声ユーティリティ
- `src/lib/storage.ts`
  - IndexedDBへのProject保存/読込/削除
- `src/components/PitchCanvas.tsx`
  - 参照/自分ピッチと差分ハイライト描画
- `src/App.tsx`
  - Project管理、練習セッション、再生制御、結果UI

## ローカル起動
```bash
npm install
npm run dev
```
- ブラウザで表示されたURLを開く（例: `http://localhost:5173`）
- 初回録音時にマイク権限を許可してください

## ビルド/静的チェック
```bash
npm run lint
npm run build
```

## 使い方
1. 左ペインで曲名を入力して「曲を作成」
2. 参照ボーカル（解析必須）と参照コーラス（任意）をアップロード、または参照録音ボタンで収録
3. ON/OFF, Solo, 音量と位置補正(ms)で参照再生を調整
4. 参照トラック位置合わせブロックで、BPM/拍子/クリック音量/クリックオフセットを調整
5. 「練習開始」→2秒後に録音開始、終わったら「停止して解析」
6. 結果画面で統計・グラフ・外れ区間を確認
7. 必要なら許容誤差/clarity/手動オフセットを変更して再解析

## マイルストーン別の動作確認手順
### 1. プロジェクト/参照管理
- 新規曲を作成できる
- 参照ボーカル/コーラスのアップロード/参照録音が反映される
- ページ再読み込み後もProjectが残る

### 2. 練習録音
- 「練習開始」でマイク許可ダイアログが出る
- 2秒カウント後に録音中ステータスになる
- 「停止して解析」で録音がセッションとして保存される

### 3. 解析/可視化
- グラフに参照と自分のピッチが重なって表示される
- 統計カードの値が表示される
- 外れ区間トップ3のクリックで該当時刻付近を再生できる

### 4. パラメータ再解析
- 許容誤差・clarity・手動オフセットの変更後、再解析ボタンで結果が更新される

## 対応ブラウザ
- Chrome / Edge（最新版推奨）

## 既知の制限
- スマホUIは未対応（PC優先）
- 評価軸はピッチ中心（詳細なタイミング/安定性評価は未実装）
- 長尺・高負荷環境では解析に時間がかかる
- モデル推定のため初回解析はロード待ちが発生する
- オフライン前提だが、Google Fonts読込のため初回のみネットワークがあると表示が安定

## データ取り扱い
- 音声データ・解析結果はブラウザ内（IndexedDB）にのみ保存
- 外部API送信は行いません

## 今後の拡張候補（MVPの次）
1. 苦手区間ループ再生
2. 録音中リアルタイムピッチ表示
3. WAV/JSON/PNGエクスポート
4. 安定性（ビブラート/揺れ）評価
